# Исследование формата дискет АГАТ 840 Кб


Перед тем, как начать описывать путь, который я прошел от изучения формата физической дискеты до создания эмулятора дисковода, нужно сказать пару слов о видах кодирования информации на магнитных дисках.

На физическом уровне информация записывается на дискету в виде изменения направления магнитного поля в точке находящейся под головкой дисковода. При чтении, когда головка дисковода проходит над областями изменения магнитного поля, на ее выходе формируется электрический потенциал, который после усиления и преобразования превращается в электрические импульсы на контакте «READ DATA» разъёма дисковода. Каждому изменению - соответствует логическая единица, отсутствию изменения – ноль.

В наиболее распространенном на АГАТ 840Кб дисководе ИЗОТ ЕС5323.01, как и во многих других современных дисководах, логическая единица соответствует низкому напряжению (0 В), логический ноль – высокому (5 В). Active low. 
> Хотя в дисководе АГАТ на 140Кб, клоне Shugart SA-400 - инвертированы только некоторые управляющие сигналы, а данные передаются в нормальном виде.

Для того чтобы успешно считать записанные на дискету данные, контроллер должен четко понимать, сколько нолей было между двумя единицами, а т.к. скорость вращения дискеты не всегда стабильна и дискета может быть загрязнена, то контроллеру будет очень сложно отличить 50 нолей, следующих подряд от 51. А если вспомнить закон Мерфи: «Все что может сломаться – обязательно сломается».

Поэтому был придуман способ кодирования данных, при котором ограничивается количество следующих друг за другом бит одного типа. Самые распространенные методы кодирования информации на дискетах и ранних жестких дисках это FM, MFM, CGR. Хорошая [статья][1] на эту тему от инженеров компании Shugart Associates, создавшей первые дисководы на ГМД. В формате 840Кб используется именно MFM для хранения данных.

Закодировать данные в MFM очень просто:
* Один (1) всегда кодируется в “01”
* Ноль (0) кодируется в “00”, если предыдущий бит данных был 1, иначе в “10”

Таким образом после кодирования, мы можем получить не более трех нолей подряд.

Пример: 11000101 закодируется в 0101001010010001.
> Что делать, если данные начинаются с ноля, и мы не знаем значение предыдущего бита? 
> Такой ноль нужно кодировать в “00”, как будто перед ним была единица.

Данные на дискетах записываются концентрическими дорожками вдоль направления вращения диска, в формате Агат 840Кб на дискету помещается по 80 дорожек с каждой стороны магнитного диска. Нумеруются они последовательно: четные дорожки с номерами: 0,2,4,6..158 на одной стороне, нечетные: 1,3,5,7..159 на другой. Всего 160 дорожек.

Каждая дорожка разбита на секторы, в формате 840Кб их 21. Cектор содержит поле адреса, в котором указана метка тома, номер дорожки и номер сектора. И поле данных, состоящее из 256 байт данных + 1 байта контрольной суммы. Сектора, поля адреса и данных обычно разделены техническими промежутками (GAP).


## От теории к практике. 
Первое, что я сделал для того, чтобы понять, как информация хранится на дискете – снял [полный дамп](agat-840-files/8 MHz, 96 M Samples - IKP7A.logicdata?raw=true) загрузки [ИКП](http://agatcomp.ru/Apps/Ikp17.shtml) [(образ)](agat-840-files/IKP_7A.DSK?raw=true). В графическом виде он представлен ниже.

![ikp-dump]( agat-840-files/ikp-dump.png?raw=true)

В левой части окна даны названия соответствующих сигналов на 34 контактном разъеме дисковода. В средней части мы видим waveform представление сигналов. 
Назначение сигналов:
*	INDEX – импульс длительностью 3 мс формируется в момент прохождения головки над первым сектором каждой дорожки. 
*	READ – импульсы данных с поверхности дискеты.
*	SIDE ONE – равен 0, если чтение идет с 0 (нижней) стороны дискеты и 1 если чтение идет с 1 (верхней) стороны.
*	DIRECTION – направление движения головок дисковода: 0 – в сторону убывания номера дорожки, 1 – в сторону возрастания.
*	STEP – при каждом единичном импульсе, головка должна перейти на соседнюю дорожку в направлении DIRECTION
*	READY – сигнал равен 1, если дисковод готов передавать данные.
*	TRACT 0 – сигнал равен 1, если головка дисковода находится на 0 (внешней) дорожке.
*	DRIVE EN 0 – при установке в 1 активирует первый дисковод на шлейфе.
Все сигнальные линии со стороны дисковода подтянуты к +5В и по умолчанию имеют логический уровень 0.

Если мы увеличим сигнал данных, то сможем заметить следующие закономерности.
![ikp-dump-detail]( agat-840-files/ikp-dump-detail.png?raw=true)
 
Я отметил их маркерами. Видно, что у нас есть три варианта длительности импульсов нулевого логического уровня, равных примерно 4, 6, 8 миллисекундам соответственно. При этом длительность единицы примерно равна 1 мс.

Очень похоже на последовательности, получаемые при MFM кодировании:
*	101
*	1001
*	10001

В программе логического анализатора есть возможность экспортировать захваченные данные в [файл формата CSV](agat-840-files/IKP_7A-read.csv?raw=true), где в первой колонке будет номер семпла, а во второй - логический уровень (0/1). Причем для экономии новая строчка добавляется только при изменении уровня.

Пример содержимого файла:
```
Sample, Read
12448187, 1
12448189, 0
12448198, 1
12448236, 0
12448244, 1
12448284, 0
12448292, 1
12448329, 0
12448338, 1
12448362, 0
12448371, 1
```

Я подумал, что было бы неплохо декодировать содержимое этого файла, в полноценный поток битов, добавив пропущенные ноли между единицами. А потом уже попытаться преобразовать его в осмысленные данные.

Поэтому я составил небольшую программу на PHP, считающую количество семплов между соседними единицами, и если оно соответствует некоему количеству, то считать, что у нас 1, 2 или 3 последовательных ноля. Но, как видно из Рис. 2, расстояние между единицами может варьироваться, т.к. мы имеем дело с аналоговым сигналом, да и скорость вращения диска может плавать. Я решил, что можно подсчитать количество возможных длин импульсов, чтобы получить диапазоны возможных значений для каждого типа последовательности.

Вот что из этого получилось для 0 и 1 в графическом виде [(исходник)](agat-840-files/IKP_7A-stats.txt):
<img width=600 src=agat-840-files/stats0.png?raw=true></img><img width=250 src=agat-840-files/stats1.png?raw=true></img>

На диаграммах наглядно видно, что все импульсы можно объединить в 4 группы:
<table><tr><th>Тип<th>Семплов<th>Микросекунд<th>Код</tr>
<tr><td>0<td>	0 - 30<td>	2,75-3,125<td>	0
<tr><td>0<td>	31 - 45<td>	4,5-5<td>	00
<tr><td>0<td>	46 - …<td>	6,5-7<td>	000
<tr><td>1<td>	любой<td>	1-1,125<td>	1
</table>

Так как нам известна частота дискретизации, с которой записывались данные 8МГц (8 Мсемплов/с), получаем, что 1 семпл равен 
0,125 микросекунды, это дает нам возможность рассчитать диапазоны допустимой длительности участков 0 и 1 уровня для последующей эмуляции.

Я задал в программе вышеуказанные цифры и получил на выходе [поток данных](agat-840-files/IKP_7A-decoded.txt?raw=true) в виде 0 и 1, закодированных в MFM. Пример:
```
010010010010100100100010010101001001010100101010100010101010010101001010010010001000100101010010010101010101010010001000101010001000100100100010010101010101010101001010101000101010101000100010001001010010010101010101001000101010010010100010001010101010010101010101001001001000100010010101010101010010001010100100101000101000101000100101010101010010010010001000100101010101010010100101001001010010100010010101001010101001010100100010010100100101010010010100101000101010100010100010101010100010010101010101001001010100100010010100100101010010001010101000101010001001010100100101010101010010010101001000100101001001010010100010101010001010101001010010001001010101010100100100100101001001010010010101001010010010001001010100100101010010101000101010010100100101010101001001010010101010010101010100100100100101010101001001010010100101010010100100101000100101010101010100101010001010001010100100101010101001001010100101010101010010
```

Дальше мне пришлось обратиться к интернету для поиска информации о логическом формате дискет АГАТ 840Кб, [описание][2] которого удалось найти в составе комплекта ПО за авторством kapitan-u, для преобразования образов дискет Агата в внутренний формат эмулятора дисковода HxC. Также помогли исходники утилит преобразования dsk в nibble и информация на сайте [agatcomp.ru](http://agatcomp.ru).

```
Aghat 840k

MFM, 300rpm, 250000 bps

5"25 80 Tracks, 21 Sectors per track, Sector 256 bytes, 2 sides, 860160 bytes formatted. Un-Formatted track capacity 6250 bytes.
=============================================================================
DOS Track format
1. GAP1 13x 0xAA bytes
2. 21 sectors of the following format:
2.1 Desync 0xA1
2.2 0xFF may be any byte, not available sor software
2.2 Address field: 
    0x95, 0x6A (2 byte address field mark),
    volume number (1 byte, default 0xFE),
    Track number (1 byte 0x00 - 0x14),
    Sector number (1 byte),
    0x5A (1 byte End of address field mark)
2.3 GAP 5x 0xAA bytes
2.4 Desync 0xA1
2.5 0xFF may be any byte, not available sor software
2.6 Data field:
    0x6A, 0x95 (2 byte data field mark),
    256 Data Bytes,
    CRC(1 byte),
    0x5A (1 byte End of data field mark)
2.7 GAP3 22x 0xAA bytes
3. There is NO GAP4, after last sector track is exactly 6250 bytes

Agath is using Apple 2 Disk checksum algorithm.
Despite of being called "simple arithmetic sum" is is more complicated:

function CalcCRC(const d: tSec): Byte;
var c: Word; n: Byte;
begin
  c:=0;
  for n:=0 to 255 do begin
    if c>255 then begin inc(c); c:=c and 255 end;
    inc(c,d[n]);
  end;
  CalcCRC:=c and 255;
end;


Sector numbering is 0..20, Sector order and interleave is not important. Usual sector order is 0..20
Address field has no disk side information. Tracks are numbered 0..159 and present on disk in following order:

Track 0, Side 0: Track 0 
Track 0, Side 1: Track 1 
Track 1, Side 0: Track 2 
Track 1, Side 1: Track 3 
And so on.
```

Из него мы делаем вывод, что поля адреса и данных начинаются с desync (или синхросбоя), представляющего из себя последовательность бит, которой не может быть при правильном MFM кодировании. Эта последовательность нужна, чтобы контроллер дисковода понимал, что далее последует блок адреса или данных.

Например, последовательность 0xA1 (0b10100001), упомянутая в описании выше, по правилам должна кодироваться как «0100010010101001», а реально используется «010**0**010010001001» с одной единицей замененной нолем.

Я попробовал поискать по файлу с бинарными данными эту последовательность, но ничего не нашлось ;(. Перепроверив все еще раз, я решил зайти с другой стороны и поискать идентификатор поля адреса «0x95, 0x6A», в MFM виде «01001001000100010001010001000100». Эта подстрока нашлась в файле несколько раз с определенной периодичностью, что подтверждало правильность декодирования.

Потратив немного времени на анализ содержимого файла в текстовом редакторе, я вычислил, что реальный desync для формата АГАТ 840Кб представляет собой «10**0**0100100100100» или «0x12» в шестнадцатеричном виде. Следом за ним стоит обязательный байт 0xFF, недоступный для ОС. 

Теперь мы можем декодировать адреса и данные из дампа, рассчитать контрольные суммы по вышеприведенному алгоритму и сравнить полученное с каноническим образом диска ИКП в формате DSK. Вот что получилось после декодирования первых двух секторов нулевой дорожки:
```
addr: 95 6a fe 00 00 5a
addr_parsed: 254:0:0  Checksum: OK (6d)
data: 6a 95 01 8d 09 c4 a5 2b 4a 4a 4a 4a 09 c0 8d 25 08 ae 26 08 30 31 bd 27 08 85 3d bd 36 08 85 27 ce 26 08 a6 2b 4c 5c c0 0e 0f 0d 0b 09 07 05 03 01 0e 0c 0a 08 06 04 02 3e 3c 3a 38 36 34 32 30 3d 3b 39 37 35 33 31 a5 2b 8d ae 39 8d 63 3b 4c 10 3a a0 fa c1 e7 d0 f5 f6 c1 c5 d4 a0 e9 a0 c2 f9 fa f9 c2 c1 c5 d4 a0 d4 d0 c5 e2 f5 c5 cd f9 ea a0 e2 ec cf cb a0 c3 e9 c3 d4 c5 cd f9 8d a0 cf d2 c7 a0 a4 b8 b0 b0 a0 cd c1 c9 ce c6 d2 c1 cd c5 8d bb 8d d3 c8 d5 c7 a0 c5 d1 d5 a0 b0 8d bb 8d bb a0 a0 a8 b1 a9 a0 cb cf c8 c3 d4 c1 c8 d4 f9 8d d4 c9 d4 cc c5 ce a0 c5 d1 d5 a0 b5 8d c2 cc d5 c5 c3 cf cc a0 c5 d1 d5 a0 a4 b2 c3 8d c2 c9 d4 a0 c5 d1 d5 a0 a4 b2 c3 8d d5 ce c9 d4 ae c3 cf c4 a0 c5 d1 d5 a0 a4 c6 c4 8d d5 ce c9 d4 d9 d0 c5 a0 c5 d1 d5 a0 a4 c6 c6 8d c5 d8 d4 d2 c1 6d 5a

addr: 95 6a fe 00 01 5a
addr_parsed: 254:0:1  Checksum: OK (83)
data: 6a 95 08 ac 01 39 f0 12 cc 00 39 d0 08 20 c6 31 cd 0d 39 f0 12 20 f9 30 b0 69 ac 00 39 a9 00 20 94 30 b0 5d 20 c6 31 8d 0d 39 ad 06 39 c9 06 f0 5e b0 4e 4a f0 40 bc 33 39 d0 da ee 32 39 9d 33 39 08 c9 02 ad 07 39 9d 4b 39 ad 08 39 9d 63 39 ad 09 39 9d 7b 39 f0 16 b0 14 6d 07 39 9d 4b 39 b0 03 de 63 39 38 a9 00 fd 7b 39 9d 7b 39 a9 00 8d 09 39 28 b0 12 20 f9 30 b0 08 ac 06 39 d0 08 2c a9 02 48 20 d0 30 68 28 c9 01 ae 18 39 60 20 e3 31 90 f4 b0 ed 85 3e cc 01 39 18 f0 ed 20 d0 30 b9 ad 39 f0 3f 8d 0a 39 8c 01 39 b9 b9 39 8d 0c 39 b9 b1 39 8d 0b 39 be b5 39 bd e9 30 85 2a bd ea 30 85 2b a0 1a b1 2a 99 17 39 88 10 f8 6c 1c 39 ae 01 39 f0 b4 ad 0c 39 9d b9 39 a9 00 8d 01 39 6c 1e 39 68 68 a9 02 d0 9d 7c 32 43 36 a0 12 88 d0 fd ea 38 e9 01 d0 f5 60 8d 20 c0 78 ad 32 39 83 5a
```

Рассчитанные данные полностью совпали с образом дискеты ИКП.

### Ссылки
1. John F. Hoeppener, Larry H. Wall, "Encoding/Decoding Techniques Double Floppy Disc Capacity" [PDF][1]
[1]: agat-840-files/cd-8002-1.pdf "Encoding/Decoding Techniques Double Floppy Disc Capacity"
2. Oleksandr Kapitanenko, "Agat-7 (Apple II USSR) 800kb disk support" [WWW][2]
[2]: http://www.torlus.com/floppy/forum/viewtopic.php?f=19&t=1385
3. Программа для просмотра дампов логического анализатора в формате ".logicdata" [WWW](https://www.saleae.com/downloads)
